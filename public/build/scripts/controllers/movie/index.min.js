var Movie=require("../../models/movie/movie"),Category=require("../../models/movie/category"),City=require("../../models/movie/city");exports.index=function(e,t){var o=e.query.galleryName,i=e.query.className,n=e.query.suggest,r=e.query.search;r&&n?City.findOne({cityName:n}).exec(function(e,o){var i=[];if(o){var n=o.name;i=n.toString().match(new RegExp("[^\\u0000-\\u00FF]{0,}"+r+"[^\\u0000-\\u00FF]{0,}","g")),e&&console.log(e),t.json(i)}}):n?City.findOne({cityName:n}).exec(function(e,o){e&&console.log(e),t.json({data:o})}):i?Category.findOne({name:i}).populate({path:"movies",select:"title poster",option:{limit:6}}).exec(function(e,o){e&&console.log(e),t.json({data:o})}):o?Category.findOne({name:o}).populate({path:"movies",select:"title poster",option:{limit:6}}).exec(function(e,o){e&&console.log(e),t.json({data:o})}):Category.find({}).populate({path:"movies",select:"title poster",option:{limit:6}}).exec(function(e,o){e&&console.log(e),t.render("movie/index",{title:"豆瓣电影首页",categories:o})})},exports.search=function(e,t){var o=e.query.cat,i=e.query.q,n=e.query.p;n=parseInt(e.query.p,10)||0;var r=6,a=n*r;o?Category.find({_id:o}).populate({path:"movies",select:"title poster"}).exec(function(e,i){e&&console.log(e);var l=i[0]||{},s=l.movies||[],c=s.slice(a,a+r);t.render("movie/results",{title:"豆瓣电影搜索结果列表页面",keyword:l.name,currentPage:n+1,query:"cat="+o,totalPage:Math.ceil(s.length/r),movies:c})}):Movie.find({title:new RegExp(i+".*","i")}).exec(function(e,o){e&&console.log(e);var l=o.slice(a,a+r);t.render("movie/results",{title:"豆瓣电影搜索结果列表页面",keyword:i,currentPage:n+1,query:"q="+i,totalPage:Math.ceil(o.length/r),movies:l})})},exports.fullpage=function(e,t){t.render("movie/fullpage",{title:"豆瓣电影广告页面"})};