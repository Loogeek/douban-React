var Movie=require("../../models/movie/movie"),CommentMovie=require("../../models/movie/comment"),Category=require("../../models/movie/category"),underscore=require("underscore"),fs=require("fs"),path=require("path");exports.detail=function(e,o){var i=e.params.id;Movie.update({_id:i},{$inc:{pv:1}},function(e){e&&console.log(e)}),Movie.findById(i,function(e,n){CommentMovie.find({movie:i}).populate("from","name").populate("reply.from reply.to","name").exec(function(e,i){o.render("movie/detail",{title:"豆瓣电影详情页",movie:n,comments:i})})})},exports["new"]=function(e,o){Category.find({},function(e,i){o.render("movie/admin",{title:"豆瓣电影后台录入页",categories:i,movie:{}})})},exports.savePoster=function(e,o,i){var n=e.files.uploadPoster,t=n.path,r=n.originalFilename;r?fs.readFile(t,function(o,t){var r=Date.now(),a=n.type.split("/")[1],s=r+"."+a,c=path.join(__dirname,"../../","/public/upload/"+s);fs.writeFile(c,t,function(o){e.poster=s,i()})}):i()},exports.save=function(e,o){var i,n=e.body.movie._id,t=e.body.movie;if(e.poster&&(t.poster=e.poster),n)Movie.findById(n,function(e,n){e&&console.log(e),i=underscore.extend(n,t),i.save(function(e,i){e&&console.log(e),o.redirect("/movie/"+i._id)})});else{i=new Movie(t);var r=t.category,a=t.categoryName;i.save(function(e,i){if(e&&console.log(e),r)Category.findById(r,function(e,n){n.movies.push(i._id),n.save(function(e,n){o.redirect("/movie/"+i._id)})});else if(a){var n=new Category({name:a,movies:[i._id]});n.save(function(e,n){i.category=n._id,i.save(function(e,i){o.redirect("/movie/"+i._id)})})}})}},exports.update=function(e,o){var i=e.params.id;Movie.findById(i,function(e,i){Category.find({},function(e,n){e&&console.log(e),o.render("movie/admin",{title:"豆瓣电影后台更新页",movie:i,categories:n})})})},exports.list=function(e,o){Movie.find({}).populate("category","name").exec(function(e,i){e&&console.log(e),o.render("movie/list",{title:"豆瓣电影列表页",movies:i})})},exports.del=function(e,o){var i=e.query.id;i&&Movie.remove({_id:i},function(e,i){e&&console.log(e),o.json({success:1})})};