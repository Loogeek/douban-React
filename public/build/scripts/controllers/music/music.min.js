var Music=require("../../models/music/music"),CommentMusic=require("../../models/movie/comment"),MusicCategory=require("../../models/music/musicCategory"),underscore=require("underscore"),fs=require("fs"),path=require("path");exports.detail=function(e,i){var s=e.params.id;Music.update({_id:s},{$inc:{pv:1}},function(e){e&&console.log(e)}),Music.findById(s,function(e,n){CommentMusic.find({music:s}).populate("from","name").populate("reply.from reply.to","name").exec(function(e,s){i.render("music/detail",{title:"豆瓣音乐详情页",music:n,comments:s})})})},exports["new"]=function(e,i){MusicCategory.find({},function(e,s){i.render("music/admin",{title:"豆瓣音乐后台录入页",musicCategories:s,music:{}})})},exports.savePoster=function(e,i,s){var n=e.files.uploadMusicImage,o=n.path,c=n.originalFilename;c?fs.readFile(o,function(i,o){var c=Date.now(),u=n.type.split("/")[1],t=c+"."+u,r=path.join(__dirname,"../../","/public/upload/"+t);fs.writeFile(r,o,function(i){e.image=t,s()})}):s()},exports.save=function(e,i){var s,n=e.body.music._id,o=e.body.music;if(e.image&&(o.image=e.image),n)Music.findById(n,function(e,n){e&&console.log(e),s=underscore.extend(n,o),s.save(function(e,s){e&&console.log(e),i.redirect("/music/"+s._id)})});else{var c=o.musicCategory,u=o.musicCategoryName;s=new Music(o),s.save(function(e,s){if(e&&console.log(e),c)MusicCategory.findById(c,function(e,n){n.musics.push(s._id),n.save(function(e,n){i.redirect("/music/"+s._id)})});else if(u){var n=new MusicCategory({name:u,musics:[s._id]});n.save(function(e,n){s.musicCategory=n._id,s.save(function(e,s){i.redirect("/music/"+s._id)})})}})}},exports.update=function(e,i){var s=e.params.id;Music.findById(s,function(e,s){MusicCategory.find({},function(e,n){e&&console.log(e),i.render("music/admin",{title:"豆瓣音乐后台更新页",music:s,musicCategories:n})})})},exports.list=function(e,i){Music.find({}).populate("musicCategory","name").exec(function(e,s){e&&console.log(e),i.render("music/list",{title:"豆瓣音乐列表页",musics:s})})},exports.del=function(e,i){var s=e.query.id;s&&Music.remove({_id:s},function(e,s){e&&console.log(e),i.json({success:1})})};